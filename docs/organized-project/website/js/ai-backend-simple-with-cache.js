const AI_ENDPOINT="<REDACTED_CREDENTIAL>";function addMessageToChat(e,s,t={}){const n=document.getElementById("chatMessages");if(!n)return;const a=document.createElement("div");a.className=`chat-message ${s}-message`;const i=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});if("user"===s)a.innerHTML=`\n            <div class="d-flex align-items-start mb-3 justify-content-end">\n                <div class="message-content">\n                    <div class="bg-primary text-white p-3 rounded">\n                        <p class="mb-0">${escapeHtml(e)}</p>\n                    </div>\n                    <small class="text-muted">You • ${i}</small>\n                </div>\n                <div class="avatar bg-secondary text-white rounded-circle d-flex align-items-center justify-content-center ms-3" style="width: 40px; height: 40px;">\n                    <i class="bi bi-person"></i>\n                </div>\n            </div>\n        `;else{const s=t.cached?'<span class="badge bg-info ms-2" title="Instant cached response"><i class="bi bi-lightning-fill"></i> Cached</span>':"",n=t.guardrails?'<span class="badge bg-success ms-1" title="AI safety guardrails active"><i class="bi bi-shield-check"></i></span>':"",c=t.error?'<span class="badge bg-warning ms-1" title="Fallback response"><i class="bi bi-exclamation-triangle"></i></span>':"";if(a.innerHTML=`\n            <div class="d-flex align-items-start mb-3">\n                <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">\n                    <i class="bi bi-robot"></i>\n                </div>\n                <div class="message-content">\n                    <div class="bg-light p-3 rounded">\n                        <div class="message-text">${formatMessage(e)}</div>\n                    </div>\n                    <small class="text-muted">\n                        AI Assistant • ${i}\n                        ${s}\n                        ${n}\n                        ${c}\n                    </small>\n                </div>\n            </div>\n        `,t.searchResults&&t.searchResults.length>0){const e=document.createElement("div");e.className="search-results-preview mt-2",e.innerHTML=`\n                <div class="alert alert-info alert-sm">\n                    <small>\n                        <i class="bi bi-database me-1"></i>\n                        Based on ${t.searchResults.length} health data points\n                    </small>\n                </div>\n            `,a.querySelector(".message-content").appendChild(e)}}n.appendChild(a),n.scrollTop=n.scrollHeight}function formatMessage(e){return escapeHtml(e).replace(/\n/g,"<br>").replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>").replace(/\*(.*?)\*/g,"<em>$1</em>").replace(/•/g,"&bull;")}function escapeHtml(e){const s=document.createElement("div");return s.textContent=e,s.innerHTML}function showTypingIndicator(){const e=document.getElementById("chatMessages");if(!e)return null;const s="typing-"+Date.now(),t=document.createElement("div");return t.id=s,t.className="chat-message ai-message",t.innerHTML='\n        <div class="d-flex align-items-start mb-3">\n            <div class="avatar bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-3" style="width: 40px; height: 40px;">\n                <i class="bi bi-robot"></i>\n            </div>\n            <div class="message-content">\n                <div class="bg-light p-3 rounded">\n                    <div class="typing-dots">\n                        <span></span>\n                        <span></span>\n                        <span></span>\n                    </div>\n                </div>\n                <small class="text-muted">AI Assistant is thinking...</small>\n            </div>\n        </div>\n    ',e.appendChild(t),e.scrollTop=e.scrollHeight,s}function removeTypingIndicator(e){if(e){const s=document.getElementById(e);s&&s.remove()}}function updateStatusIndicators(e){const s=document.querySelector('[data-status="mode"]');if(s){const t=e.cached?"Cached + Live AI":"Live AI Assistant";s.innerHTML=`<span class="badge bg-success">${t}</span>`}}window.sendMessage=async function(){const e=document.getElementById("chatInput"),s=document.getElementById("chatMessages");if(!e||!s)return void console.error("Chat elements not found");const t=e.value.trim();if(!t)return;e.value="",addMessageToChat(t,"user");const n=showTypingIndicator();try{let e,s=!1;if(window.isSampleQuestion&&window.getCachedSampleResponse){const n=window.getCachedSampleResponse(t);n&&(e={response:n.response,cached:!0,cache_hit:!0,guardrails_active:n.guardrails_active,search_results:n.search_results||[]},s=!0,await new Promise(e=>setTimeout(e,800)),console.log("✅ Using cached response for sample question"))}if(!s){const s=await fetch(AI_ENDPOINT,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({message:t,user_id:"web_user",session_id:"web_session"})});if(!s.ok)throw new Error(`API request failed: ${s.status}`);e=await s.json(),console.log("✅ Received API response")}removeTypingIndicator(n),addMessageToChat(e.response,"ai",{cached:s,guardrails:e.guardrails_active,searchResults:e.search_results}),void 0!==e.guardrails_active&&updateStatusIndicators(e)}catch(e){console.error("Error sending message:",e),removeTypingIndicator(n),addMessageToChat("I'm having trouble processing your request right now. Please try again later.\n\nFor immediate health concerns, please contact your healthcare provider.","ai",{error:!0})}},document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("chatInput");e&&e.addEventListener("keypress",function(e){"Enter"===e.key&&sendMessage()})}),console.log("✅ Enhanced AI Backend Integration with Cache loaded");