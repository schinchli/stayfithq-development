const OPENSEARCH_MCP_CONFIG={searchEndpoint:"https://hx35ws84zd.execute-api.us-east-1.amazonaws.com/prod/search",timeout:15e3,retryAttempts:2};let mcpStatus={connected:!1,lastChecked:null,indexReady:!1};async function initializeOpenSearchMCP(){console.log("üîç Initializing OpenSearch MCP...");try{(await performHealthCheck()).success?(mcpStatus.connected=!0,mcpStatus.indexReady=!0,updateMCPStatusIndicators(!0),await indexSampleHealthData(),console.log("‚úÖ OpenSearch MCP initialized successfully")):(mcpStatus.connected=!1,updateMCPStatusIndicators(!1),console.warn("‚ö†Ô∏è OpenSearch MCP health check failed"))}catch(e){console.error("‚ùå OpenSearch MCP initialization failed:",e),mcpStatus.connected=!1,updateMCPStatusIndicators(!1)}mcpStatus.lastChecked=(new Date).toISOString()}async function performHealthCheck(){try{const e=await fetch(OPENSEARCH_MCP_CONFIG.searchEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({action:"health_check"}),timeout:OPENSEARCH_MCP_CONFIG.timeout});if(!e.ok)throw new Error(`Health check failed: ${e.status}`);const t=await e.json();return console.log("üè• OpenSearch cluster health:",t),{success:"healthy"===t.status,clusterStatus:t.cluster_status,nodes:t.number_of_nodes}}catch(e){return console.error("Health check error:",e),{success:!1,error:e.message}}}async function searchHealthData(e,t="web_user",a={}){try{if(!mcpStatus.connected)return console.warn("OpenSearch MCP not connected, using fallback"),getFallbackSearchResults(e);const s={action:"search",query:e,user_id:t,filters:a,limit:10},n=await fetch(OPENSEARCH_MCP_CONFIG.searchEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(s),timeout:OPENSEARCH_MCP_CONFIG.timeout});if(!n.ok)throw new Error(`Search failed: ${n.status}`);const c=await n.json();return console.log(`üîç Found ${c.total} results for: "${e}"`),{success:!0,results:c.results,total:c.total,query:c.query}}catch(t){return console.error("Search error:",t),{success:!1,error:t.message,results:getFallbackSearchResults(e)}}}async function indexHealthData(e,t="web_user"){try{if(!mcpStatus.connected)return console.warn("OpenSearch MCP not connected, skipping indexing"),{success:!1,error:"MCP not connected"};const a={action:"index",data:e,user_id:t},s=await fetch(OPENSEARCH_MCP_CONFIG.searchEndpoint,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(a),timeout:OPENSEARCH_MCP_CONFIG.timeout});if(!s.ok)throw new Error(`Indexing failed: ${s.status}`);const n=await s.json();return console.log("üìù Health data indexed:",n.document_id),{success:!0,documentId:n.document_id,indexed:n.indexed}}catch(e){return console.error("Indexing error:",e),{success:!1,error:e.message}}}async function indexSampleHealthData(){const e=[{type:"heart_rate",value:72,unit:"bpm",timestamp:(new Date).toISOString(),source:"fitness_tracker",metadata:{activity:"resting",heart_rate_zone:"zone1"}},{type:"steps",value:8247,unit:"steps",timestamp:(new Date).toISOString(),source:"smartphone",metadata:{activity:"walking"}},{type:"sleep",value:7.5,unit:"hours",timestamp:new Date(Date.now()-288e5).toISOString(),source:"sleep_tracker",metadata:{sleep_stage:"deep_sleep"}},{type:"blood_pressure",value:120,unit:"mmHg",timestamp:(new Date).toISOString(),source:"blood_pressure_monitor",metadata:{systolic:120,diastolic:80}}];console.log("üìä Indexing sample health data...");for(const t of e)await indexHealthData(t,"demo_user"),await new Promise(e=>setTimeout(e,500));console.log("‚úÖ Sample health data indexed")}function getFallbackSearchResults(e){const t=[{id:"fallback_1",score:1,data_type:"heart_rate",value:72,unit:"bpm",timestamp:(new Date).toISOString(),source:"cached",relevance:"high"},{id:"fallback_2",score:.8,data_type:"steps",value:8247,unit:"steps",timestamp:(new Date).toISOString(),source:"cached",relevance:"medium"}],a=e.toLowerCase();return t.filter(e=>e.data_type.includes(a)||a.includes(e.data_type))}function updateMCPStatusIndicators(e){const t=document.querySelector('[data-status="opensearch"]'),a=document.querySelector('[data-status="mode"]');t&&(t.innerHTML=e?'<span class="badge bg-success">Connected</span>':'<span class="badge bg-warning">Not Connected</span>'),a&&e&&(a.innerHTML='<span class="badge bg-success">Live AI + Search</span>');const s=document.getElementById("mcp-status-indicator");s&&(s.innerHTML=e?'<i class="bi bi-check-circle-fill text-success"></i> OpenSearch MCP Active':'<i class="bi bi-x-circle-fill text-warning"></i> OpenSearch MCP Offline')}async function enhancedSendMessage(e,t="web_user"){try{const a=await searchHealthData(e,t),s={message:e,user_id:t,session_id:"web_session",search_context:a.success?a.results:[]},n=await fetch("https://hx35ws84zd.execute-api.us-east-1.amazonaws.com/prod/chat",{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(s)});if(!n.ok)throw new Error(`AI request failed: ${n.status}`);const c=await n.json();return{success:!0,response:c.response,searchUsed:a.success,searchResults:a.results||[],guardrailsActive:c.guardrails_active,fallbackUsed:c.fallback_used}}catch(e){return console.error("Enhanced message error:",e),{success:!1,error:e.message,response:"I'm having trouble processing your request with search capabilities right now."}}}function displaySearchResults(e,t){if(!e||0===e.length)return;const a=document.createElement("div");a.className="search-results-display mb-3",a.innerHTML=`\n        <div class="alert alert-info">\n            <h6><i class="bi bi-search me-2"></i>Relevant Health Data Found</h6>\n            <div class="row">\n                ${e.slice(0,3).map(e=>`\n                    <div class="col-md-4">\n                        <div class="card card-sm">\n                            <div class="card-body p-2">\n                                <h6 class="card-title">${e.data_type}</h6>\n                                <p class="card-text">${e.value} ${e.unit}</p>\n                                <small class="text-muted">Relevance: ${e.relevance}</small>\n                            </div>\n                        </div>\n                    </div>\n                `).join("")}\n            </div>\n            <small class="text-muted">\n                <i class="bi bi-database me-1"></i>\n                Found ${e.length} matching health records\n            </small>\n        </div>\n    `,t.appendChild(a)}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",initializeOpenSearchMCP):initializeOpenSearchMCP(),window.searchHealthData=searchHealthData,window.indexHealthData=indexHealthData,window.enhancedSendMessage=enhancedSendMessage,console.log("üîç OpenSearch MCP Integration loaded");